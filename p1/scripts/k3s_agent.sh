sudo apt-get update
sudo apt-get install curl -y

# disable swap
sudo swapoff -a
sudo sed -i '/ swap / s/^\(.*\)$/#\1/g' /etc/fstab

until [ -f /vagrant/confs/node-token ]; do
	sleep 3
done


TOKEN=$(cat /vagrant/confs/node-token)

curl -sfL https://get.k3s.io | K3S_URL="https://${K3S_SERVER_IP}:6443" K3S_TOKEN="${TOKEN}" sh -
Jan 20 16:58:49 hsharameSW systemd[1]: Starting k3s-agent.service - Lightweight Kubernetes...
Jan 20 16:58:50 hsharameSW k3s[2277]: time="2026-01-20T16:58:50Z" level=info msg="Acquiring lock file /var/lib/rancher/k3s/data/.lock"
Jan 20 16:58:50 hsharameSW k3s[2277]: time="2026-01-20T16:58:50Z" level=info msg="Preparing data dir /var/lib/rancher/k3s/data/ffd82c56f7aadb3263c7708547a6027705a0eb9a638534465002ba309cae9990"
Jan 20 16:59:00 hsharameSW k3s[2277]: time="2026-01-20T16:59:00Z" level=info msg="Starting k3s agent v1.34.3+k3s1 (48ffa7b6)"
Jan 20 16:59:00 hsharameSW k3s[2277]: time="2026-01-20T16:59:00Z" level=info msg="Updated load balancer k3s-agent-load-balancer default server: 192.168.56.110:6443"
Jan 20 16:59:00 hsharameSW k3s[2277]: time="2026-01-20T16:59:00Z" level=info msg="Running load balancer k3s-agent-load-balancer 127.0.0.1:6444 -> [] [default: 192.168.56.110:6443]"
Jan 20 16:59:20 hsharameSW k3s[2277]: time="2026-01-20T16:59:20Z" level=error msg="Failed to validate connection to cluster at https://192.168.56.110:6443: failed to get CA certs: Get \"https://127.0.0.1:6444/cacerts\": context deadline exceeded (Client.Timeout exceeded while awaiting headers)"
Jan 20 16:59:42 hsharameSW k3s[2277]: time="2026-01-20T16:59:42Z" level=error msg="Failed to validate connection to cluster at https://192.168.56.110:6443: failed to get CA certs: Get \"https://127.0.0.1:6444/cacerts\": context deadline exceeded (Client.Timeout exceeded while awaiting headers)"
Jan 20 17:00:04 hsharameSW k3s[2277]: time="2026-01-20T17:00:04Z" level=error msg="Failed to validate connection to cluster at https://192.168.56.110:6443: failed to get CA certs: Get \"https://127.0.0.1:6444/cacerts\": context deadline exceeded (Client.Timeout exceeded while awaiting headers)"
Jan 20 17:00:26 hsharameSW k3s[2277]: time="2026-01-20T17:00:26Z" level=error msg="Failed to validate connection to cluster at https://192.168.56.110:6443: failed to get CA certs: Get \"https://127.0.0.1:6444/cacerts\": context deadline exceeded (Client.Timeout exceeded while awaiting headers)"
Jan 20 17:00:48 hsharameSW k3s[2277]: time="2026-01-20T17:00:48Z" level=error msg="Failed to validate connection to cluster at https://192.168.56.110:6443: failed to get CA certs: Get \"https://127.0.0.1:6444/cacerts\": context deadline exceeded (Client.Timeout exceeded while awaiting headers)"
Jan 20 17:01:10 hsharameSW k3s[2277]: time="2026-01-20T17:01:10Z" level=error msg="Failed to validate connection to cluster at https://192.168.56.110:6443: failed to get CA certs: Get \"https://127.0.0.1:6444/cacerts\": context deadline exceeded (Client.Timeout exceeded while awaiting headers)"
Jan 20 17:01:32 hsharameSW k3s[2277]: time="2026-01-20T17:01:32Z" level=error msg="Failed to validate connection to cluster at https://192.168.56.110:6443: failed to get CA certs: Get \"https://127.0.0.1:6444/cacerts\": context deadline exceeded (Client.Timeout exceeded while awaiting headers)"
Jan 20 17:01:54 hsharameSW k3s[2277]: time="2026-01-20T17:01:54Z" level=error msg="Failed to validate connection to cluster at https://192.168.56.110:6443: failed to get CA certs: Get \"https://127.0.0.1:6444/cacerts\": context deadline exceeded (Client.Timeout exceeded while awaiting headers)"
Jan 20 17:02:16 hsharameSW k3s[2277]: time="2026-01-20T17:02:16Z" level=error msg="Failed to validate connection to cluster at https://192.168.56.110:6443: failed to get CA certs: Get \"https://127.0.0.1:6444/cacerts\": context deadline exceeded (Client.Timeout exceeded while awaiting headers)"
Jan 20 17:02:53 hsharameSW k3s[2277]: time="2026-01-20T17:02:53Z" level=info msg="Waiting to retrieve agent configuration; server is not ready: failed to retrieve configuration from server: Get \"https://127.0.0.1:6444/v1-k3s/config\": context deadline exceeded (Client.Timeout exceeded while awaiting headers)"
Jan 20 17:03:20 hsharameSW k3s[2277]: time="2026-01-20T17:03:20Z" level=info msg="Waiting to retrieve agent configuration; server is not ready: failed to retrieve configuration from server: Get \"https://127.0.0.1:6444/v1-k3s/config\": context deadline exceeded (Client.Timeout exceeded while awaiting headers)"
Jan 20 17:03:44 hsharameSW k3s[2277]: time="2026-01-20T17:03:44Z" level=info msg="Waiting to retrieve agent configuration; server is not ready: failed to retrieve configuration from server: Get \"https://127.0.0.1:6444/v1-k3s/config\": context deadline exceeded (Client.Timeout exceeded while awaiting headers)"
Jan 20 17:04:13 hsharameSW k3s[2277]: time="2026-01-20T17:04:13Z" level=info msg="Waiting to retrieve agent configuration; server is not ready: CA cert validation failed: Get \"https://127.0.0.1:6444/cacerts\": context deadline exceeded (Client.Timeout exceeded while awaiting headers)"
Jan 20 17:04:45 hsharameSW k3s[2277]: time="2026-01-20T17:04:45Z" level=info msg="Waiting to retrieve agent configuration; server is not ready: failed to retrieve configuration from server: Get \"https://127.0.0.1:6444/v1-k3s/config\": context deadline exceeded (Client.Timeout exceeded while awaiting headers)"
Jan 20 17:05:14 hsharameSW k3s[2277]: time="2026-01-20T17:05:14Z" level=info msg="Waiting to retrieve agent configuration; server is not ready: failed to retrieve configuration from server: Get \"https://127.0.0.1:6444/v1-k3s/config\": context deadline exceeded (Client.Timeout exceeded while awaiting headers)"
Jan 20 17:05:47 hsharameSW k3s[2277]: time="2026-01-20T17:05:47Z" level=info msg="Waiting to retrieve agent configuration; server is not ready: failed to retrieve configuration from server: Get \"https://127.0.0.1:6444/v1-k3s/config\": context deadline exceeded (Client.Timeout exceeded while awaiting headers)"
Jan 20 17:06:16 hsharameSW k3s[2277]: time="2026-01-20T17:06:16Z" level=info msg="Waiting to retrieve agent configuration; server is not ready: failed to retrieve configuration from server: Get \"https://127.0.0.1:6444/v1-k3s/config\": context deadline exceeded (Client.Timeout exceeded while awaiting headers)"
Jan 20 17:06:49 hsharameSW k3s[2277]: time="2026-01-20T17:06:49Z" level=info msg="Waiting to retrieve agent configuration; server is not ready: Get \"https://127.0.0.1:6444/v1-k3s/client-ca.crt\": context deadline exceeded (Client.Timeout exceeded while awaiting headers)"
Jan 20 17:07:22 hsharameSW k3s[2277]: time="2026-01-20T17:07:22Z" level=info msg="Waiting to retrieve agent configuration; server is not ready: Get \"https://127.0.0.1:6444/v1-k3s/server-ca.crt\": context deadline exceeded (Client.Timeout exceeded while awaiting headers)"
Jan 20 17:07:52 hsharameSW k3s[2277]: time="2026-01-20T17:07:52Z" level=info msg="Waiting to retrieve agent configuration; server is not ready: failed to retrieve configuration from server: Get \"https://127.0.0.1:6444/v1-k3s/config\": context deadline exceeded (Client.Timeout exceeded while awaiting headers)"
Jan 20 17:08:19 hsharameSW k3s[2277]: time="2026-01-20T17:08:19Z" level=info msg="Waiting to retrieve agent configuration; server is not ready: CA cert validation failed: Get \"https://127.0.0.1:6444/cacerts\": context deadline exceeded (Client.Timeout exceeded while awaiting headers)"
Jan 20 17:08:46 hsharameSW k3s[2277]: time="2026-01-20T17:08:46Z" level=info msg="Waiting to retrieve agent configuration; server is not ready: failed to retrieve configuration from server: Get \"https://127.0.0.1:6444/v1-k3s/config\": context deadline exceeded (Client.Timeout exceeded while awaiting headers)"
Jan 20 17:09:24 hsharameSW k3s[2277]: time="2026-01-20T17:09:24Z" level=info msg="Waiting to retrieve agent configuration; server is not ready: failed to retrieve configuration from server: Get \"https://127.0.0.1:6444/v1-k3s/config\": context deadline exceeded (Client.Timeout exceeded while awaiting headers)"
Jan 20 17:09:57 hsharameSW k3s[2277]: time="2026-01-20T17:09:57Z" level=info msg="Waiting to retrieve agent configuration; server is not ready: failed to retrieve configuration from server: Get \"https://127.0.0.1:6444/v1-k3s/config\": context deadline exceeded (Client.Timeout exceeded while awaiting headers)"
Jan 20 17:10:20 hsharameSW k3s[2277]: time="2026-01-20T17:10:20Z" level=info msg="Waiting to retrieve agent configuration; server is not ready: failed to retrieve configuration from server: Get \"https://127.0.0.1:6444/v1-k3s/config\": context deadline exceeded (Client.Timeout exceeded while awaiting headers)"
Jan 20 17:10:48 hsharameSW k3s[2277]: time="2026-01-20T17:10:48Z" level=info msg="Waiting to retrieve agent configuration; server is not ready: failed to retrieve configuration from server: Get \"https://127.0.0.1:6444/v1-k3s/config\": context deadline exceeded (Client.Timeout exceeded while awaiting headers)"
Jan 20 17:11:19 hsharameSW k3s[2277]: time="2026-01-20T17:11:19Z" level=info msg="Waiting to retrieve agent configuration; server is not ready: failed to retrieve configuration from server: Get \"https://127.0.0.1:6444/v1-k3s/config\": context deadline exceeded (Client.Timeout exceeded while awaiting headers)"
Jan 20 17:11:38 hsharameSW k3s[2277]: time="2026-01-20T17:11:38Z" level=info msg="Waiting to retrieve agent configuration; server is not ready: failed to retrieve configuration from server: Get \"https://127.0.0.1:6444/v1-k3s/config\": context deadline exceeded (Client.Timeout exceeded while awaiting headers)"
Jan 20 17:12:03 hsharameSW k3s[2277]: time="2026-01-20T17:12:03Z" level=info msg="Waiting to retrieve agent configuration; server is not ready: failed to retrieve configuration from server: Get \"https://127.0.0.1:6444/v1-k3s/config\": context deadline exceeded (Client.Timeout exceeded while awaiting headers)"
Jan 20 17:12:27 hsharameSW k3s[2277]: time="2026-01-20T17:12:27Z" level=info msg="Waiting to retrieve agent configuration; server is not ready: CA cert validation failed: Get \"https://127.0.0.1:6444/cacerts\": context deadline exceeded (Client.Timeout exceeded while awaiting headers)"
Jan 20 17:12:55 hsharameSW k3s[2277]: time="2026-01-20T17:12:55Z" level=info msg="Waiting to retrieve agent configuration; server is not ready: failed to get CA certs: Get \"https://127.0.0.1:6444/cacerts\": context deadline exceeded (Client.Timeout exceeded while awaiting headers)"
Jan 20 17:13:31 hsharameSW k3s[2277]: time="2026-01-20T17:13:31Z" level=info msg="Waiting to retrieve agent configuration; server is not ready: CA cert validation failed: Get \"https://127.0.0.1:6444/cacerts\": context deadline exceeded (Client.Timeout exceeded while awaiting headers)"
Jan 20 17:13:58 hsharameSW k3s[2277]: time="2026-01-20T17:13:58Z" level=info msg="Waiting to retrieve agent configuration; server is not ready: failed to get CA certs: Get \"https://127.0.0.1:6444/cacerts\": context deadline exceeded (Client.Timeout exceeded while awaiting headers)"
Jan 20 17:14:27 hsharameSW k3s[2277]: time="2026-01-20T17:14:27Z" level=info msg="Waiting to retrieve agent configuration; server is not ready: failed to get CA certs: Get \"https://127.0.0.1:6444/cacerts\": context deadline exceeded (Client.Timeout exceeded while awaiting headers)"
Jan 20 17:15:02 hsharameSW k3s[2277]: time="2026-01-20T17:15:02Z" level=info msg="Waiting to retrieve agent configuration; server is not ready: CA cert validation failed: Get \"https://127.0.0.1:6444/cacerts\": context deadline exceeded (Client.Timeout exceeded while awaiting headers)"
Jan 20 17:15:30 hsharameSW k3s[2277]: time="2026-01-20T17:15:30Z" level=info msg="Waiting to retrieve agent configuration; server is not ready: failed to get CA certs: Get \"https://127.0.0.1:6444/cacerts\": context deadline exceeded (Client.Timeout exceeded while awaiting headers)"
Jan 20 17:15:58 hsharameSW k3s[2277]: time="2026-01-20T17:15:58Z" level=info msg="Waiting to retrieve agent configuration; server is not ready: failed to get CA certs: Get \"https://127.0.0.1:6444/cacerts\": context deadline exceeded (Client.Timeout exceeded while awaiting headers)"
Jan 20 17:16:24 hsharameSW k3s[2277]: time="2026-01-20T17:16:24Z" level=info msg="Waiting to retrieve agent configuration; server is not ready: failed to get CA certs: Get \"https://127.0.0.1:6444/cacerts\": context deadline exceeded (Client.Timeout exceeded while awaiting headers)"
Jan 20 17:16:51 hsharameSW k3s[2277]: time="2026-01-20T17:16:51Z" level=info msg="Waiting to retrieve agent configuration; server is not ready: failed to get CA certs: Get \"https://127.0.0.1:6444/cacerts\": context deadline exceeded (Client.Timeout exceeded while awaiting headers)"
Jan 20 17:17:20 hsharameSW k3s[2277]: time="2026-01-20T17:17:20Z" level=info msg="Waiting to retrieve agent configuration; server is not ready: failed to get CA certs: Get \"https://127.0.0.1:6444/cacerts\": context deadline exceeded (Client.Timeout exceeded while awaiting headers)"
Jan 20 17:17:46 hsharameSW k3s[2277]: time="2026-01-20T17:17:46Z" level=info msg="Waiting to retrieve agent configuration; server is not ready: failed to get CA certs: Get \"https://127.0.0.1:6444/cacerts\": context deadline exceeded (Client.Timeout exceeded while awaiting headers)"
Jan 20 17:18:13 hsharameSW k3s[2277]: time="2026-01-20T17:18:13Z" level=info msg="Waiting to retrieve agent configuration; server is not ready: failed to get CA certs: Get \"https://127.0.0.1:6444/cacerts\": context deadline exceeded (Client.Timeout exceeded while awaiting headers)"
Jan 20 17:18:42 hsharameSW k3s[2277]: time="2026-01-20T17:18:42Z" level=info msg="Waiting to retrieve agent configuration; server is not ready: failed to get CA certs: Get \"https://127.0.0.1:6444/cacerts\": context deadline exceeded (Client.Timeout exceeded while awaiting headers)"
Jan 20 17:19:10 hsharameSW k3s[2277]: time="2026-01-20T17:19:10Z" level=info msg="Waiting to retrieve agent configuration; server is not ready: failed to get CA certs: Get \"https://127.0.0.1:6444/cacerts\": context deadline exceeded (Client.Timeout exceeded while awaiting headers)"
Jan 20 17:19:36 hsharameSW k3s[2277]: time="2026-01-20T17:19:36Z" level=info msg="Waiting to retrieve agent configuration; server is not ready: failed to get CA certs: Get \"https://127.0.0.1:6444/cacerts\": context deadline exceeded (Client.Timeout exceeded while awaiting headers)"
